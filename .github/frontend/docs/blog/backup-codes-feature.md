---
title: 备用恢复码功能
date: 2025-06-28
slug: backup-codes-feature
tags: [security, totp, backup, feature]
---

# 备用恢复码功能

## 概述

在用户设置完二次验证后，系统现在支持在账户安全设置主页面查看、下载和打印备用恢复码。这个功能为用户提供了更好的账户恢复选项。

## 功能特性

### 1. 查看备用恢复码

- 在 TOTP 管理页面显示"查看备用恢复码"按钮
- 点击后弹出模态框显示所有可用的恢复码
- 支持显示/隐藏恢复码以保护隐私

### 2. 下载功能

- 支持将恢复码下载为文本文件
- 文件名格式：`backup-codes-YYYY-MM-DD.txt`
- 包含重要的安全提示和使用说明

### 3. 打印功能

- 支持直接打印恢复码
- 优化的打印布局，包含安全提示
- 适合保存纸质备份

## 技术实现

### 后端 API

#### 新增路由

```typescript
// GET /api/totp/backup-codes
router.get("/backup-codes", TOTPController.getBackupCodes);
```

#### 控制器方法

```typescript
public static async getBackupCodes(req: Request, res: Response) {
  // 验证用户权限
  // 检查TOTP是否启用
  // 返回用户的备用恢复码
}
```

### 前端组件

#### BackupCodesModal 组件

- 显示备用恢复码的模态框
- 支持查看、下载、打印功能
- 响应式设计，适配移动端

#### TOTPManager 组件更新

- 添加"查看备用恢复码"按钮
- 集成 BackupCodesModal 组件
- 优化用户界面布局

## 安全考虑

### 1. 访问控制

- 只有已启用 TOTP 的用户才能访问
- 需要有效的认证令牌
- 验证用户身份

### 2. 数据保护

- 恢复码默认隐藏，需要用户主动显示
- 下载和打印功能包含安全提示
- 建议用户妥善保管恢复码

### 3. 使用限制

- 每个恢复码只能使用一次
- 使用后自动从用户账户中移除
- 防止重复使用

## 用户体验

### 1. 界面设计

- 现代化的 UI 设计
- 清晰的视觉层次
- 直观的操作流程

### 2. 交互反馈

- 加载状态指示
- 错误信息提示
- 成功操作确认

### 3. 移动端适配

- 响应式布局
- 触摸友好的按钮
- 优化的移动端体验

## 使用流程

### 1. 设置二次验证

1. 用户进入 TOTP 设置页面
2. 扫描 QR 码或手动输入密钥
3. 系统生成 10 个备用恢复码
4. 用户验证并启用 TOTP

### 2. 查看恢复码

1. 在 TOTP 管理页面点击"查看备用恢复码"
2. 系统验证用户权限
3. 显示恢复码列表
4. 用户可以选择下载或打印

### 3. 使用恢复码

1. 在无法使用认证器时
2. 登录时选择使用恢复码
3. 输入一个未使用的恢复码
4. 系统验证并允许登录

## 文件结构

```
src/
├── controllers/
│   └── totpController.ts          # 添加getBackupCodes方法
├── routes/
│   └── totpRoutes.ts              # 添加backup-codes路由
└── tests/
    └── backupCodes.test.ts        # 新增测试文件

frontend/src/
├── components/
│   ├── TOTPManager.tsx            # 更新，添加查看按钮
│   └── BackupCodesModal.tsx       # 新增组件
└── types/
    └── auth.ts                    # 添加BackupCodesResponse类型
```

## 测试覆盖

### 单元测试

- 后端 API 功能测试
- 前端组件测试
- 错误处理测试

### 集成测试

- 完整的用户流程测试
- 权限验证测试
- 跨浏览器兼容性测试

## 未来改进

### 1. 功能增强

- 支持重新生成恢复码
- 添加恢复码使用历史
- 支持批量操作

### 2. 安全增强

- 添加恢复码过期机制
- 支持加密存储
- 添加使用通知

### 3. 用户体验

- 支持二维码分享
- 添加语音播报
- 支持多语言

## 注意事项

1. **备份重要性**：提醒用户妥善保管恢复码
2. **一次性使用**：每个恢复码只能使用一次
3. **安全存储**：建议用户将恢复码保存在安全的地方
4. **定期检查**：建议用户定期检查剩余恢复码数量
