---
title: TOTP 二次验证功能说明
date: 2025-06-21
slug: TOTP_README
---

# TOTP 二次验证功能说明

## 概述

本系统已集成完整的 TOTP（基于时间的一次性密码）二次验证功能，为用户账户提供额外的安全保护。

## 功能特性

### ✅ 已实现功能

1. **TOTP 设置**

   - 生成 TOTP 密钥和 QR 码
   - 支持手动输入密钥
   - 生成 10 个备用恢复码
   - 验证并启用 TOTP

2. **登录验证**

   - 用户启用 TOTP 后，登录时需要额外验证
   - 支持 6 位数字验证码
   - 支持 8 位字母数字恢复码
   - 验证失败次数限制（5 次后锁定 15 分钟）

3. **用户界面**

   - 响应式设计，支持手机端滚动
   - 美观的模态框界面
   - 实时输入验证
   - 错误提示和帮助信息

4. **安全特性**
   - 防止暴力破解（尝试次数限制）
   - 临时 token 机制
   - 输入清理和验证
   - 安全的密钥生成

## 使用流程

### 1. 用户注册/登录

```
用户注册 → 登录 → 如果启用了TOTP → 显示TOTP验证界面
```

### 2. 设置 TOTP

```
用户登录 → 进入TOTP管理 → 生成设置 → 扫描QR码 → 输入验证码 → 启用成功
```

### 3. 登录验证

```
用户登录 → 输入用户名密码 → 系统检查TOTP状态 → 需要验证 → 输入6位验证码或恢复码 → 验证成功 → 登录完成
```

## 技术实现

### 后端 API

- `POST /api/auth/login` - 登录（返回 requiresTOTP 状态）
- `POST /api/totp/generate-setup` - 生成 TOTP 设置
- `POST /api/totp/verify-and-enable` - 验证并启用 TOTP
- `POST /api/totp/verify-token` - 验证 TOTP 令牌（登录时使用）
- `POST /api/totp/disable` - 禁用 TOTP
- `GET /api/totp/status` - 获取 TOTP 状态

### 前端组件

- `AuthForm.tsx` - 登录表单，集成 TOTP 验证
- `TOTPVerification.tsx` - TOTP 验证界面（登录时使用）
- `TOTPSetup.tsx` - TOTP 设置界面
- `TOTPManager.tsx` - TOTP 管理界面

### 安全机制

1. **验证尝试限制**

   - 最多 5 次尝试
   - 失败后锁定 15 分钟
   - 成功验证后重置计数

2. **临时 Token**

   - 登录时生成临时 token
   - 5 分钟有效期
   - 仅用于 TOTP 验证

3. **输入验证**
   - 验证码格式检查（6 位数字）
   - 恢复码格式检查（8 位字母数字）
   - 输入清理和 sanitization

## 手机端优化

### 响应式设计

- 使用 Tailwind CSS 的响应式类
- 支持不同屏幕尺寸
- 自适应布局

### 滚动支持

- 模态框内容可滚动
- 最大高度限制（90vh）
- 防止内容溢出

### 触摸友好

- 合适的按钮大小
- 清晰的输入框
- 易于点击的界面元素

## 测试

### 运行测试脚本

```bash
node test-totp-login.js
```

### 手动测试步骤

1. 注册新用户
2. 登录并设置 TOTP
3. 使用认证器应用扫描 QR 码
4. 输入验证码完成设置
5. 退出登录
6. 重新登录，验证 TOTP 功能

## 注意事项

1. **认证器应用**

   - 推荐使用 Google Authenticator、Microsoft Authenticator 等
   - 支持标准 TOTP 协议

2. **恢复码**

   - 请妥善保存备用恢复码
   - 恢复码使用后会被移除
   - 建议打印或保存在安全位置

3. **安全建议**
   - 定期更换 TOTP 密钥
   - 不要在公共设备上启用 TOTP
   - 保持认证器应用更新

## 故障排除

### 常见问题

1. **验证码错误**

   - 检查时间同步
   - 确认输入正确的 6 位数字
   - 尝试使用恢复码

2. **QR 码无法扫描**

   - 手动输入密钥
   - 检查认证器应用是否支持 TOTP
   - 确保网络连接正常

3. **账户被锁定**
   - 等待 15 分钟锁定时间
   - 使用恢复码登录
   - 联系管理员重置

### 错误代码

- `400` - 验证码格式错误
- `401` - 未授权访问
- `429` - 尝试次数过多
- `500` - 服务器内部错误

## 开发说明

### 环境要求

- Node.js 16+
- Express.js
- React 18+
- Tailwind CSS

### 依赖包

- `speakeasy` - TOTP 生成和验证
- `qrcode` - QR 码生成
- `framer-motion` - 动画效果

### 配置

- TOTP 密钥长度：32 字符
- 验证窗口：±2 个时间步
- 时间步长：30 秒
- 备用恢复码数量：10 个
